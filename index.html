<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALTA: Automated Lead Triage Agent</title>
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border-bottom: 1px solid #e5e7eb;
            scroll-behavior: smooth;
        }
        .message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 18px;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .user-message {
            background-color: #4f46e5; /* Indigo */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .ai-message {
            background-color: #ffffff; /* White */
            color: #1f2937; /* Dark gray text */
            margin-right: auto;
            border: 1px solid #d1d5db;
            border-bottom-left-radius: 4px;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden">

        <!-- Header -->
        <header class="bg-indigo-600 text-white p-4 text-center rounded-t-xl">
            <h1 class="text-2xl font-bold">ALTA: Automated Lead Triage Agent</h1>
            <p class="text-sm opacity-90">Your Zero-Investment AI Automation System</p>
        </header>

        <div class="flex flex-col lg:flex-row p-6 space-y-6 lg:space-y-0 lg:space-x-6">

            <!-- Chat Interface (What the Client Sees) -->
            <div class="w-full lg:w-1/3 bg-gray-100 p-4 rounded-lg shadow-inner flex flex-col h-full min-h-[500px]">
                <h2 class="text-lg font-semibold mb-3 text-indigo-700">Client Chat Demo</h2>
                <div id="chat-messages" class="chat-container flex-grow p-2 bg-white rounded-lg shadow-md">
                    <!-- Messages go here -->
                </div>

                <!-- Input Field -->
                <div class="mt-4 flex">
                    <input type="text" id="user-input" placeholder="Ask your question..." class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="send-button" class="bg-indigo-600 text-white p-3 rounded-r-lg font-semibold hover:bg-indigo-700 transition duration-150">Send</button>
                </div>
                <p id="status-message" class="text-sm mt-2 text-center text-gray-500">System Status: Initializing...</p>
            </div>

            <!-- Dashboard (Your Profit Engine) -->
            <div class="w-full lg:w-2/3 p-4 rounded-lg shadow-inner bg-gray-50 flex flex-col">
                <h2 class="text-lg font-semibold mb-3 text-green-700">ALTA Lead Dashboard (Your Profit Engine)</h2>
                <p class="text-sm text-gray-600 mb-4">This is the proof of value for your client. We track only the **Qualified Leads**. **Total Qualified Leads: <span id="qualified-count" class="font-bold text-lg text-green-600">0</span>**</p>

                <div class="overflow-x-auto rounded-lg shadow-md flex-grow">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-2 px-4 text-left text-xs font-medium text-gray-600 uppercase w-1/12">Time</th>
                                <th class="py-2 px-4 text-left text-xs font-medium text-gray-600 uppercase w-5/12">Initial Query</th>
                                <th class="py-2 px-4 text-left text-xs font-medium text-gray-600 uppercase w-3/12">AI Status</th>
                                <th class="py-2 px-4 text-left text-xs font-medium text-gray-600 uppercase w-3/12">Contact Info</th>
                            </tr>
                        </thead>
                        <tbody id="leads-table-body" class="divide-y divide-gray-200">
                            <!-- Leads dynamically inserted here -->
                            <tr>
                                <td colspan="4" class="text-center py-8 text-gray-500 italic" id="empty-state">Waiting for data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p class="text-xs mt-3 text-gray-400 text-right">Data is stored locally in your browser's session for this demo.</p>
            </div>

        </div>
    </div>

    <!-- JavaScript and AI Logic -->
    <script type="module">
        // --- 1. CONFIGURATION ---
        // *** CRITICAL: API Key is set to empty string to use the secure, auto-injected key provided by the environment. ***
        const apiKey = "AIzaSyDW7D3dmjubRe8Bm_oS2MyFmPqpbMIZzRQ";
        const modelName = "gemini-2.5-flash-preview-09-2025";
        // Final URL construction (handles local vs. hosted keys)
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

        // This is the **CRUCIAL** specialized prompt for the Financial Advisor niche.
        const systemPrompt = {
            parts: [{
                text: `You are a Lead Qualification AI for a Financial Advisor specializing in high-net-worth clients. Your primary goal is to qualify leads based on investment intent and portfolio size. **You MUST ONLY respond with the requested JSON object and ABSOLUTELY NO other text, characters, or markdown before or after the JSON.**

                Qualification Criteria:
                - 'Qualified' if the user mentions needing investment management for an amount > ₹15,0,000, mentions a high-value need (e.g., retirement planning, tax optimization for large assets), or explicitly asks for a meeting/consultation.
                - 'Unqualified' if the user asks for free general tips, basic budgeting advice, or for information on starting SIPs with a small amount (< ₹50,000).

                Your response MUST be a single JSON object.
                JSON Schema:
                {
                    "qualification": "Qualified" or "Unqualified",
                    "followUp": "A short, confident, and professional next question to keep the conversation going."
                }

                If Qualified, your followUp must immediately ask for their preferred contact method (email or phone) to schedule a private consultation. If Unqualified, provide a general, brief answer and ask a gentle question to clarify their potential high-value needs.`
            }]
        };

        // Define the common response schema structure for strict JSON output
        const RESPONSE_SCHEMA = {
            type: "OBJECT",
            properties: {
                "qualification": { "type": "STRING", "enum": ["Qualified", "Unqualified"] },
                "followUp": { "type": "STRING" }
            }
        };


        // --- 2. DOM Elements & State ---
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const leadsTableBody = document.getElementById('leads-table-body');
        const qualifiedCountElement = document.getElementById('qualified-count');
        const statusMessageElement = document.getElementById('status-message');
        const emptyState = document.getElementById('empty-state');

        let chatHistory = [];
        const MAX_RETRIES = 4;
        const LOCAL_STORAGE_KEY = 'alta-leads';

        // --- 3. UI Functions ---

        function updateStatus(message, color = 'text-gray-500') {
            statusMessageElement.className = `text-sm mt-2 text-center ${color}`;
            statusMessageElement.textContent = message;
        }

        function displayMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender === 'user' ? 'user-message ml-auto' : 'ai-message'}`;
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to bottom
        }

        function showThinkingState() {
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.className = 'ai-message flex items-center space-x-2 animate-pulse';
            typingIndicator.innerHTML = `
                <span class="inline-block h-3 w-3 bg-indigo-400 rounded-full"></span>
                <span class="inline-block h-3 w-3 bg-indigo-400 rounded-full"></span>
                <span class="inline-block h-3 w-3 bg-indigo-400 rounded-full"></span>
                <span class="text-sm">Analyzing request...</span>
            `;
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideThinkingState() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // --- 4. Local Storage (Database Replacement) Functions ---

        function loadLeads() {
            const leads = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            renderLeads(leads);
            return leads;
        }

        function saveLead(lead) {
            const leads = loadLeads();
            leads.push(lead);
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(leads));
            renderLeads(leads);
        }

        function renderLeads(leads) {
            leadsTableBody.innerHTML = '';

            if (leads.length === 0) {
                leadsTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-500 italic" id="empty-state">Waiting for data...</td></tr>`;
                qualifiedCountElement.textContent = 0;
                return;
            }

            let qualifiedCount = 0;

            // Display in reverse chronological order (newest first)
            leads.slice().reverse().forEach(lead => {
                if (lead.qualification === 'Qualified') {
                    qualifiedCount++;
                }

                const statusColor = lead.qualification === 'Qualified' ? 'text-green-600 font-bold' : 'text-yellow-600';
                const contactDisplay = lead.contact || 'N/A';

                const row = `
                    <tr>
                        <td class="py-2 px-4 text-sm text-gray-500">${new Date(lead.timestamp).toLocaleTimeString()}</td>
                        <td class="py-2 px-4 text-sm text-gray-800">${lead.query.substring(0, 100)}...</td>
                        <td class="py-2 px-4 text-sm ${statusColor}">${lead.qualification}</td>
                        <td class="py-2 px-4 text-sm text-gray-800">${contactDisplay}</td>
                    </tr>
                `;
                leadsTableBody.innerHTML += row;
            });

            qualifiedCountElement.textContent = qualifiedCount;
        }

        // --- 5. Gemini API Call Logic with Retry ---

        async function fetchGeminiResponse(userQuery, retries = 0) {

            // Build the payload with the strict schema enforcement
            const payload = {
                contents: [{ role: "user", parts: [{ text: userQuery }] }],

                // Strict enforcement of JSON output format
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: RESPONSE_SCHEMA
                },

                // System Instruction applies the persona and rules
                config: {
                    systemInstruction: systemPrompt
                }
            };

            try {
                // If API Key is the default placeholder, let the environment inject the real key
                const currentApiUrl = apiKey === "" ?
                    `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=` :
                    apiUrl;

                const response = await fetch(currentApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API returned status ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                // Extracting text from JSON part (Gemini returns the JSON string in 'text')
                let jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) {
                    throw new Error("API response was valid, but contained no JSON content.");
                }

                // Aggressive JSON extraction using RegExp to skip any preamble text.
                const jsonMatch = jsonText.match(/\{[^]*\}/);

                if (!jsonMatch || jsonMatch.length === 0) {
                    throw new Error(`Response structure does not contain a valid JSON block. Full output: ${jsonText}`);
                }

                jsonText = jsonMatch[0]; // Take the matched JSON string

                return JSON.parse(jsonText);

            } catch (error) {
                console.error(`Attempt ${retries + 1} failed:`, error.message);

                // Only retry if we haven't hit the limit
                if (retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000; // Exponential backoff: 1s, 2s, 4s, 8s
                    await new Promise(resolve => setTimeout(resolve, delay));
                    // Retry with the original query
                    return fetchGeminiResponse(userQuery, retries + 1);
                }
                throw new Error(`Failed to connect to the AI service after ${MAX_RETRIES} retries. Check console.`);
            }
        }

        // --- 6. Main Triage and Conversation Flow ---

        function extractContactInfo(query) {
            const emailMatch = query.match(/[\w.-]+@[\w.-]+\.\w+/);
            if (emailMatch) return emailMatch[0];
            const phoneMatch = query.match(/(\d{3}[\s-]?\d{3}[\s-]?\d{4})|(\d{5}[\s-]?\d{5})/);
            if (phoneMatch) return phoneMatch[0];
            return null;
        }

        async function handleUserInput() {
            const userQuery = userInput.value.trim();
            if (!userQuery) return;

            // Clear input and disable
            userInput.value = '';
            sendButton.disabled = true;
            userInput.disabled = true;

            // 1. Display user message
            displayMessage(userQuery, 'user');

            // 2. Show thinking state
            showThinkingState();
            updateStatus("Analyzing request with specialized AI...", 'text-indigo-600');

            try {
                // 3. Get AI triage and follow-up (Pass only the current userQuery)
                const aiResponse = await fetchGeminiResponse(userQuery);

                // 4. Log lead data
                const contact = extractContactInfo(userQuery);
                const leadData = {
                    query: userQuery,
                    qualification: aiResponse.qualification,
                    followUp: aiResponse.followUp,
                    contact: contact,
                    timestamp: Date.now()
                };
                saveLead(leadData); // Saves to local storage and updates dashboard

                // 5. Display AI response
                const aiMessageText = aiResponse.followUp;

                hideThinkingState();
                displayMessage(aiMessageText, 'ai');

                updateStatus(`Last lead status: ${aiResponse.qualification}`, aiResponse.qualification === 'Qualified' ? 'text-green-600 font-bold' : 'text-yellow-600');

            } catch (error) {
                hideThinkingState();
                const errorMessage = `**AI Triage Failed:** The AI service could not process the request. (Error: ${error.message}). Please retry or rephrase.`;
                displayMessage(errorMessage, 'ai');
                console.error("Fatal Triage Error:", error);
                updateStatus("AI Triage Failed. Check console.", 'text-red-600');
            } finally {
                // Re-enable input
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        // --- 7. Initialization ---

        function initialize() {
            // Load and render existing leads from local storage
            loadLeads();

            // Set up event listeners
            sendButton.addEventListener('click', handleUserInput);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleUserInput();
                }
            });

            // Initial AI welcome message (first chat history entry)
            const welcomeMessage = "Welcome to your high-value financial consultation service. How may I assist you with your investment needs today?";
            displayMessage(welcomeMessage, 'ai');

            updateStatus("System Ready! Waiting for client input...", 'text-green-600');
        }

        // Run the application
        initialize();

    </script>
</body>
</html>